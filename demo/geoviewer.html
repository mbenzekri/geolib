<!doctype html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/css/ol.css" type="text/css">
    <style>
        .map {
            height: 400px;
            width: 100%;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/build/ol.js"></script>
    <link rel="stylesheet" href="./geoviewer.css" type="text/css">
    <script type="systemjs-module" src="../dist/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/systemjs/dist/system.js"></script>
  
    <title>OpenLayers example</title>
</head>
<body>
    <div id="drop-area">
        <form class="my-form">
            <input type="file" id="fileElem" multiple accept="image/*" onchange="handleFiles(this.files)">
            <label class="button" for="fileElem">Select or drag/drop some files</label>
            <ul id="filelist"></ul>
        </form>
    </div>
    <div id="map" class="map"></div>
    <div id="data"></div>
    <script type="text/javascript">
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([37.41, 8.82]),
                zoom: 4
            })
        });
    </script>
</body>
<script >
    let dropArea = document.getElementById('drop-area')
    ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false)
    })

    function preventDefaults(e) {
        e.preventDefault()
        e.stopPropagation()
    }
    ;['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false)
    })

    ;['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false)
    })

    function highlight(e) {
        dropArea.classList.add('highlight')
    }

    function unhighlight(e) {
        dropArea.classList.remove('highlight')
    }
    dropArea.addEventListener('drop', handleDrop, false)

    function handleDrop(e) {
        let dt = e.dataTransfer
        let files = dt.files
        const ul = document.getElementById('filelist')
        const litems = [] 
        for (const file of files) {
            litems.push(`<li>file "${file.name}" dropped is ${file.size} bytes</li>`)
        }
        ul.innerHTML = litems.join('')
        handleFiles([...files])
    }
    function handleFiles(files) {
        for(const file of files) {
            const ext = file.name.replace(/^.*\./,'')
            let geofile = null
            switch (ext) {
                case 'shp': 
                    const dbf = files.find(f => f.name.endsWith('.dbf'))
                    geofile = dbf ? new Shapefile(f.name,file,dbf) : new Shapefile(f.name,file) 
                    break;
                case 'geojson':break
                    geofile = new Geojson(f.name,file)
                    break
                case 'csv':break
                    geofile = new Csv(f.name,file)
                    break
            }
            if (geofile) break
        }
        if (geofile) {
            const data = document.getElementById('data')
            geofile.buildIndexes([]).then( _ => {
               data.innerHTML = `Loaded ${geofile.count} feature from ${geofile.name}`
            }).catch(e => {
                data.innerHTML = `Load error for ${geofile.name} : ${err.stack}`
            })
        }
    }
</script>

</html>